rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Helper to validate string length
    function validString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }
    
    // Helper to check if user account is active
    function isActiveUser() {
      return isAuthenticated() && 
             (!exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('accountStatus', 'active') == 'active');
    }
    
    // Rate limiting helper (basic check)
    function notTooFrequent() {
      return request.time > resource.data.get('updatedAt', timestamp.date(1970, 1, 1)) + duration.value(1, 's');
    }
    
    // Enhanced validation helpers
    function validEmail(email) {
      return email is string && email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function noMaliciousContent(content) {
      return !content.matches('.*<script.*') && 
             !content.matches('.*javascript:.*') &&
             !content.matches('.*onerror=.*') &&
             !content.matches('.*onload=.*');
    }
    
    function validTimestamp() {
      return request.time < timestamp.date(2100, 1, 1);
    }
    
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    function noExtraFields(allowedFields) {
      return request.resource.data.keys().hasOnly(allowedFields);
    }
    
    // Forum posts - public read, authenticated write with validation
    match /forum_posts/{postId} {
      allow read: if true;
      allow create: if isActiveUser() && 
                      validString(request.resource.data.title, 1, 200) &&
                      validString(request.resource.data.content, 1, 10000) &&
                      noMaliciousContent(request.resource.data.title) &&
                      noMaliciousContent(request.resource.data.content) &&
                      request.resource.data.authorId == request.auth.uid &&
                      request.resource.data.likeCount == 0 &&
                      request.resource.data.replyCount == 0 &&
                      validTimestamp();
      allow update: if isOwner(resource.data.authorId) && 
                      validString(request.resource.data.title, 1, 200) &&
                      validString(request.resource.data.content, 1, 10000) &&
                      noMaliciousContent(request.resource.data.title) &&
                      noMaliciousContent(request.resource.data.content) &&
                      request.resource.data.authorId == resource.data.authorId &&
                      notTooFrequent();
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // Forum replies - public read, authenticated write with validation
    match /forum_replies/{replyId} {
      allow read: if true;
      allow create: if isActiveUser() && 
                      validString(request.resource.data.content, 1, 5000) &&
                      noMaliciousContent(request.resource.data.content) &&
                      request.resource.data.authorId == request.auth.uid &&
                      validTimestamp();
      allow update: if isOwner(resource.data.authorId) &&
                      validString(request.resource.data.content, 1, 5000) &&
                      noMaliciousContent(request.resource.data.content) &&
                      request.resource.data.authorId == resource.data.authorId &&
                      notTooFrequent();
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // Forum likes - authenticated users only
    match /forum_likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isActiveUser() && request.resource.data.userId == request.auth.uid;
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Diary entries - private, user-specific with validation
    match /diary_entries/{entryId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isActiveUser() && 
                      request.resource.data.userId == request.auth.uid &&
                      (validString(request.resource.data.content, 0, 50000) || 
                       validString(request.resource.data.encryptedContent, 0, 100000)) &&
                      validTimestamp();
      allow update: if isOwner(resource.data.userId) &&
                      (validString(request.resource.data.content, 0, 50000) || 
                       validString(request.resource.data.encryptedContent, 0, 100000)) &&
                      request.resource.data.userId == resource.data.userId &&
                      notTooFrequent();
      allow delete: if isOwner(resource.data.userId);
    }
    
    // User profiles
    match /users/{userId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      validEmail(request.resource.data.email) &&
                      validString(request.resource.data.displayName, 1, 50) &&
                      validTimestamp();
      allow update: if isOwner(userId) &&
                      request.resource.data.uid == resource.data.uid &&
                      request.resource.data.email == resource.data.email &&
                      validString(request.resource.data.displayName, 1, 50) &&
                      (!request.resource.data.keys().hasAny(['isAdmin']) || isAdmin()) &&
                      notTooFrequent();
      allow delete: if false; // Users cannot delete their own profiles
    }
    
    // Story stats - public read, controlled write
    match /storyStats/{storyId} {
      allow read: if true;
      allow create: if isAuthenticated() &&
                      request.resource.data.views >= 0 &&
                      request.resource.data.likes >= 0 &&
                      request.resource.data.bookmarks >= 0;
      allow update: if isAuthenticated() &&
                      request.resource.data.views >= resource.data.views &&
                      request.resource.data.likes >= resource.data.likes - 1 &&
                      request.resource.data.bookmarks >= resource.data.bookmarks - 1 &&
                      request.resource.data.views <= resource.data.views + 1 &&
                      request.resource.data.likes <= resource.data.likes + 1 &&
                      request.resource.data.bookmarks <= resource.data.bookmarks + 1;
    }
    
    // User interactions - user-specific read/write
    match /userInteractions/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // Comments - public read, authenticated write
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.userId);
    }
    
    // User stories - public read, authenticated write with validation
    match /userStories/{storyId} {
      allow read: if resource.data.published == true || isOwner(resource.data.authorId) || isAdmin();
      allow create: if isActiveUser() && 
                      request.resource.data.authorId == request.auth.uid &&
                      validString(request.resource.data.title, 1, 200) &&
                      validString(request.resource.data.content, 1, 500000) &&
                      noMaliciousContent(request.resource.data.title) &&
                      validTimestamp();
      allow update: if (isOwner(resource.data.authorId) || isAdmin()) &&
                      validString(request.resource.data.title, 1, 200) &&
                      validString(request.resource.data.content, 1, 500000) &&
                      noMaliciousContent(request.resource.data.title) &&
                      request.resource.data.authorId == resource.data.authorId &&
                      notTooFrequent();
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    
    // Contact messages - rate-limited creation, admin read
    match /contactMessages/{messageId} {
      allow read: if isAdmin();
      allow create: if validString(request.resource.data.name, 1, 100) &&
                      validEmail(request.resource.data.email) &&
                      validString(request.resource.data.message, 10, 5000) &&
                      noMaliciousContent(request.resource.data.message) &&
                      validTimestamp();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Admin-only collections
    match /adminSettings/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Admin logs - admin read/write only
    match /adminLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Allow creation for logging
      allow update, delete: if false; // Logs are immutable
    }
    
    // Data export requests
    match /dataExportRequests/{requestId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Content reports
    match /contentReports/{reportId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.reporterId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // User activity tracking
    match /userActivity/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow write: if isAdmin();
    }
    
    // Following system with validation
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isActiveUser() && 
                      request.resource.data.followerId == request.auth.uid &&
                      request.resource.data.followingId != request.auth.uid; // Can't follow yourself
      allow delete: if isAuthenticated() && resource.data.followerId == request.auth.uid;
    }
    
    // Follow stats - read public, write restricted
    match /followStats/{userId} {
      allow read: if true;
      allow write: if isAuthenticated() && 
                     (request.resource.data.followersCount >= 0) &&
                     (request.resource.data.followingCount >= 0); // Prevent negative counts
    }
    
    // Notifications - user-specific with validation
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                      validString(request.resource.data.title, 1, 100) &&
                      validString(request.resource.data.message, 1, 500);
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == resource.data.userId; // Can't change recipient
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Artworks - user-specific with validation
    match /artworks/{artworkId} {
      allow read: if isAuthenticated();
      allow create: if isActiveUser() && 
                      request.resource.data.userId == request.auth.uid &&
                      validString(request.resource.data.title, 1, 200) &&
                      validTimestamp();
      allow update: if isOwner(resource.data.userId) &&
                      request.resource.data.userId == resource.data.userId &&
                      notTooFrequent();
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Chain Letters - collaborative writing system
    match /chainLetters/{chainId} {
      allow read: if isAuthenticated();
      allow create: if isActiveUser() && 
                      request.resource.data.originatorId == request.auth.uid &&
                      request.resource.data.currentHolderId == request.auth.uid &&
                      validString(request.resource.data.title, 1, 200) &&
                      request.resource.data.chainLength == 1 &&
                      request.resource.data.curseLevel == 1 &&
                      validTimestamp();
      allow update: if isAuthenticated() &&
                      (isOwner(resource.data.currentHolderId) || 
                       resource.data.cursedBy.hasAny([request.auth.uid])) &&
                      request.resource.data.originatorId == resource.data.originatorId &&
                      request.resource.data.chainLength >= resource.data.chainLength &&
                      notTooFrequent();
      allow delete: if isOwner(resource.data.originatorId) || isAdmin();
    }
    
    // Chain Invitations
    match /chainInvitations/{invitationId} {
      allow read: if isAuthenticated() && 
                    (resource.data.fromUserId == request.auth.uid || 
                     resource.data.toUserId == request.auth.uid);
      allow create: if isActiveUser() && 
                      request.resource.data.fromUserId == request.auth.uid &&
                      validString(request.resource.data.chainTitle, 1, 200) &&
                      validTimestamp();
      allow update: if isAuthenticated() && 
                      resource.data.toUserId == request.auth.uid &&
                      request.resource.data.fromUserId == resource.data.fromUserId &&
                      request.resource.data.toUserId == resource.data.toUserId;
      allow delete: if isAuthenticated() && 
                      (resource.data.fromUserId == request.auth.uid || 
                       resource.data.toUserId == request.auth.uid);
    }
    
    // Chain Stats - user-specific
    match /chainStats/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
                     (userId == request.auth.uid || isAdmin()) &&
                     request.resource.data.chainsStarted >= 0 &&
                     request.resource.data.chainsContributed >= 0 &&
                     request.resource.data.chainsCompleted >= 0 &&
                     request.resource.data.chainsBroken >= 0;
    }
    
    // Chain Graveyard - public read, system write
    match /chainGraveyard/{graveyardId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // Reflection Sessions - collaborative sessions with validation
    match /reflectionSessions/{sessionId} {
      allow read: if isAuthenticated();
      allow create: if isActiveUser() && 
                      request.resource.data.hostId == request.auth.uid &&
                      validString(request.resource.data.title, 3, 100) &&
                      request.resource.data.capacity >= 2 &&
                      request.resource.data.capacity <= 8 &&
                      request.resource.data.theme in ['reflection', 'memory', 'creative', 'open'];
      allow update: if isAuthenticated() && 
                      (resource.data.hostId == request.auth.uid || // Host can update
                       request.auth.uid in request.resource.data.participants.map(p => p.userId)); // Participants can update
      allow delete: if isAuthenticated() && resource.data.hostId == request.auth.uid;
    }
    
    // Helper function to check if user is co-author
    function isCoAuthor(projectId) {
      let project = get(/databases/$(database)/documents/collaborativeProjects/$(projectId));
      return request.auth.uid in project.data.coAuthors.map(ca => ca.userId);
    }
    
    // Helper function to check if user is project owner
    function isProjectOwner(projectId) {
      let project = get(/databases/$(database)/documents/collaborativeProjects/$(projectId));
      return request.auth.uid == project.data.ownerId;
    }
    
    // Collaborative Projects - Git-like collaborative story writing
    match /collaborativeProjects/{projectId} {
      allow read: if isAuthenticated() && isCoAuthor(projectId);
      allow create: if isActiveUser() && 
                      request.resource.data.ownerId == request.auth.uid &&
                      validString(request.resource.data.title, 1, 200) &&
                      request.resource.data.status in ['recruiting', 'active', 'finalizing', 'archived'] &&
                      request.resource.data.settings.maxCoAuthors >= 2 &&
                      request.resource.data.settings.maxCoAuthors <= 20;
      allow update: if isAuthenticated() && isCoAuthor(projectId) &&
                      request.resource.data.ownerId == resource.data.ownerId &&
                      request.resource.data.linkedStoryId == resource.data.linkedStoryId;
      allow delete: if isAuthenticated() && isProjectOwner(projectId);
    }
    
    // Proposals - change requests for collaborative projects
    match /proposals/{proposalId} {
      allow read: if isAuthenticated() && 
                    isCoAuthor(resource.data.projectId);
      allow create: if isActiveUser() && 
                      request.resource.data.authorId == request.auth.uid &&
                      isCoAuthor(request.resource.data.projectId) &&
                      validString(request.resource.data.title, 1, 200) &&
                      validString(request.resource.data.description, 0, 2000);
      allow update: if isAuthenticated() && 
                      (resource.data.authorId == request.auth.uid || // Author can update
                       isProjectOwner(resource.data.projectId)) && // Owner can update
                      request.resource.data.authorId == resource.data.authorId &&
                      request.resource.data.projectId == resource.data.projectId;
      allow delete: if isAuthenticated() && 
                      (resource.data.authorId == request.auth.uid || 
                       isProjectOwner(resource.data.projectId));
    }
    
    // Project Activities - activity log for projects
    match /projectActivities/{activityId} {
      allow read: if isAuthenticated() && isCoAuthor(resource.data.projectId);
      allow create: if isAuthenticated() && isCoAuthor(request.resource.data.projectId);
      allow update, delete: if false; // Activities are immutable
    }
    
    // Join Requests - requests to join collaborative projects
    match /joinRequests/{requestId} {
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || 
                     isProjectOwner(resource.data.projectId));
      allow create: if isActiveUser() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && isProjectOwner(resource.data.projectId);
      allow delete: if isAuthenticated() && 
                      (resource.data.userId == request.auth.uid || 
                       isProjectOwner(resource.data.projectId));
    }
    
    // Saved Quotes - memorable passages from stories
    match /savedQuotes/{quoteId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isActiveUser() && 
                      request.resource.data.userId == request.auth.uid &&
                      validString(request.resource.data.quote, 10, 500) &&
                      validString(request.resource.data.storyId, 1, 200) &&
                      validString(request.resource.data.storyTitle, 1, 200) &&
                      validString(request.resource.data.storyAuthor, 1, 200) &&
                      noMaliciousContent(request.resource.data.quote) &&
                      validTimestamp();
      allow update: if isActiveUser() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == resource.data.userId &&
                      request.resource.data.storyId == resource.data.storyId &&
                      notTooFrequent();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Scrapbook Collections - user-specific photo collections
    match /scrapbookCollections/{collectionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isActiveUser() && 
                      request.resource.data.userId == request.auth.uid &&
                      validString(request.resource.data.title, 1, 100) &&
                      request.resource.data.itemCount == 0 &&
                      validTimestamp();
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == resource.data.userId &&
                      request.resource.data.itemCount >= 0 &&
                      notTooFrequent();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Scrapbook Items - items within collections
    match /scrapbookItems/{itemId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isActiveUser() && 
                      request.resource.data.userId == request.auth.uid &&
                      validString(request.resource.data.title, 1, 200) &&
                      validString(request.resource.data.imageUrl, 1, 2000) &&
                      request.resource.data.position >= 0 &&
                      validTimestamp();
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == resource.data.userId &&
                      request.resource.data.collectionId == resource.data.collectionId &&
                      notTooFrequent();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Chain Sessions - real-time collaborative story chains
    match /chainSessions/{sessionId} {
      allow read: if isAuthenticated();
      allow create: if isActiveUser() && 
                      request.resource.data.ownerId == request.auth.uid &&
                      validString(request.resource.data.title, 3, 200) &&
                      request.resource.data.maxParticipants >= 2 &&
                      request.resource.data.maxParticipants <= 50 &&
                      validTimestamp();
      allow update: if isAuthenticated() &&
                      (resource.data.ownerId == request.auth.uid || // Owner can update
                       request.auth.uid in resource.data.participants.map(p => p.userId)) && // Participants can add segments
                      request.resource.data.ownerId == resource.data.ownerId &&
                      request.resource.data.title == resource.data.title;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }
  }
}
